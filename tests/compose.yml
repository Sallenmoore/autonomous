services:
  test_db:
    image: mongo:latest
    container_name: test_db
    env_file: .testenv
    ports: # <--- ADD THIS
      - "2701:27017"
  test_cachedb:
    image: redis/redis-stack-server:latest
    container_name: test_cachedb
    env_file: .testenv
    ports: # <--- ADD THIS
      - "2702:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
  test_ollama:
    image: ollama/ollama:latest
    container_name: test_ollama_internal
    env_file: .testenv
    ports: # <--- ADD THIS
      - "2703:11434"
    volumes:
      - ollama_data:/root/.ollama
  test_media_ai:
    build:
      context: ./local_ai
    container_name: test_media_ai_internal
    env_file: .testenv
    ports: # <--- ADD THIS
      - "2704:5005"
    volumes:
      - ./model_cache:/app/ov_model_cache
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 10s
      timeout: 5s
      retries: 100
      start_period: 40s
networks:
  default:
    name: test_net

volumes:
  ollama_data:
